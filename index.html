<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Study Timer & Analytics</title>
    
    <!-- PWA / Mobile App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fef2f2">
    
    <link rel="apple-touch-icon" href="https://fav.farm/ğŸ…">
    <link rel="icon" href="https://fav.farm/ğŸ…">

    <!-- Web App Manifest -->
    <link rel="manifest" href="data:application/json,{'name':'Study Timer','short_name':'StudyTimer','start_url':'.','display':'standalone','background_color':'#ffffff','theme_color':'#fef2f2'}">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        :root {
            --theme-color: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease;
            overscroll-behavior-y: contain;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .timer-font {
            font-family: 'Inter', sans-serif;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
        }

        .mode-work { background-color: #fef2f2; --theme-color: #ef4444; }
        .mode-short-break { background-color: #f0fdf4; --theme-color: #22c55e; }
        .mode-long-break { background-color: #eff6ff; --theme-color: #3b82f6; }

        .btn-shadow {
            box-shadow: 0 4px 0 0 rgba(0,0,0,0.05);
        }
        .btn-shadow:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s, stroke 0.5s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .calendar-day { aspect-ratio: 1 / 1; }
        
        .intensity-0 { background-color: #f3f4f6; }
        .intensity-1 { background-color: #fee2e2; }
        .intensity-2 { background-color: #fca5a5; }
        .intensity-3 { background-color: #ef4444; }
        .intensity-4 { background-color: #b91c1c; }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .view-content {
            display: none;
            height: 100%;
            flex-direction: column;
            width: 100%;
        }
        .view-content.active {
            display: flex;
        }

        /* æ¨ªç”»é¢ã§ã®ãƒœã‚¿ãƒ³æŠ¼ã—ã‚„ã™ã•èª¿æ•´ */
        @media (max-height: 500px) and (orientation: landscape) {
            .timer-svg-container {
                height: 45vh !important;
                width: 45vh !important;
                margin-bottom: 0 !important;
            }
            #timer-display { font-size: 3.5rem !important; }
            .mode-tabs { margin-bottom: 0.5rem !important; }
            .controls-container { flex-direction: row !important; gap: 0.75rem !important; }
            .stats-container { display: none; }
            main { padding-top: 0.5rem !important; }
        }

        .nav-active {
            background-color: var(--theme-color) !important;
            color: white !important;
        }

        /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—æ™‚ï¼šæ¨ªä¸¦ã³ */
        @media (min-width: 1024px) {
            body { overflow: auto; height: auto; min-h-screen; }
            .view-content { display: flex !important; height: auto; }
            #mobile-nav { display: none; }
            main { flex-direction: row !important; height: auto; overflow: visible; align-items: start; }
            #timer-view { flex: 1; position: sticky; top: 2rem; }
            #analytics-view { width: 500px; }
        }
    </style>
</head>
<body class="mode-work">

    <!-- ãƒ¡ã‚¤ãƒ³ -->
    <main class="flex-grow max-w-7xl w-full mx-auto flex flex-col gap-6 p-4 md:p-8 pb-28 overflow-hidden lg:pb-8">
        
        <!-- ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ -->
        <div id="timer-view" class="view-content active bg-white rounded-3xl shadow-2xl p-6 border border-gray-100 flex-col overflow-hidden">
            <div class="flex justify-between p-1 bg-gray-100 rounded-2xl mb-6 flex-shrink-0">
                <button onclick="setMode('work')" id="tab-work" class="flex-1 py-2 px-2 rounded-xl text-xs md:text-sm font-semibold transition-all bg-white shadow-sm text-red-600">å‹‰å¼·</button>
                <button onclick="setMode('short')" id="tab-short" class="flex-1 py-2 px-2 rounded-xl text-xs md:text-sm font-semibold transition-all text-gray-500">çŸ­ä¼‘æ†©</button>
                <button onclick="setMode('long')" id="tab-long" class="flex-1 py-2 px-2 rounded-xl text-xs md:text-sm font-semibold transition-all text-gray-500">é•·ä¼‘æ†©</button>
            </div>

            <div class="flex-grow flex flex-col justify-center items-center overflow-hidden py-4">
                <div class="timer-svg-container relative flex items-center justify-center mb-8 w-64 h-64 md:w-80 md:h-80 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 320 320">
                        <circle class="text-gray-100" stroke-width="8" stroke="currentColor" fill="transparent" r="150" cx="160" cy="160" />
                        <circle id="progress-ring" class="text-red-500 progress-ring__circle" stroke-width="8" stroke-dasharray="942.48" stroke-dashoffset="0" stroke-linecap="round" stroke="currentColor" fill="transparent" r="150" cx="160" cy="160" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="timer-display" class="timer-font text-6xl md:text-8xl font-extrabold text-gray-800 tracking-tight leading-none">25:00</span>
                        <span id="current-subject-display" class="text-gray-400 mt-2 font-bold tracking-widest uppercase text-[10px] md:text-xs">Ready to Study</span>
                    </div>
                </div>

                <div class="controls-container flex gap-4 max-w-sm mx-auto w-full flex-shrink-0">
                    <button id="start-btn" onclick="handleStartClick()" class="flex-[2] py-4 bg-red-500 hover:bg-red-600 text-white rounded-2xl font-bold text-lg transition-all btn-shadow uppercase">START</button>
                    <button onclick="resetTimer()" class="flex-1 py-4 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-2xl font-bold text-lg transition-all btn-shadow uppercase">RESET</button>
                </div>
            </div>

            <div class="stats-container pt-6 border-t border-gray-100 mt-4 flex-shrink-0">
                <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">ä»Šæ—¥ã®ç´¯è¨ˆå­¦ç¿’æ™‚é–“</div>
                <div id="total-study-time" class="text-2xl md:text-3xl font-extrabold text-gray-700 timer-font uppercase leading-none">00h 00m 00s</div>
            </div>
        </div>

        <!-- è¨˜éŒ²ç”»é¢ -->
        <div id="analytics-view" class="view-content bg-white rounded-3xl shadow-xl p-6 border border-gray-100 flex-col overflow-hidden">
            <div class="flex items-center justify-between mb-6 flex-shrink-0">
                <h2 class="text-lg md:text-xl font-bold text-gray-800">å­¦ç¿’è¨˜éŒ²</h2>
                <div class="flex gap-2 text-[var(--theme-color)] transition-colors">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                    <span id="calendar-month" class="font-bold text-gray-700 min-w-[100px] text-center text-sm pt-1">2023å¹´ 10æœˆ</span>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto no-scrollbar pr-1">
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 mb-6 text-center"></div>

                <div class="pt-6 border-t border-gray-100 mb-6">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="text-sm font-bold text-gray-700">é€±é–“æ¨ç§»</h3>
                        <span id="week-label" class="text-[9px] text-gray-400 font-bold uppercase tracking-widest">Selected Week</span>
                    </div>
                    <div id="weekly-chart" class="flex items-end justify-between h-32 md:h-40 gap-1 md:gap-2 px-1"></div>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-50 flex-shrink-0">
                <button onclick="openManageModal()" class="w-full py-3 bg-gray-50 border border-gray-200 text-gray-600 rounded-2xl text-xs font-bold hover:bg-gray-100 transition-all flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                    æ•™ç§‘ã‚’è¿½åŠ ãƒ»ç®¡ç†
                </button>
            </div>
        </div>
    </main>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav id="mobile-nav" class="fixed bottom-0 left-0 w-full pb-8 pt-4 px-4 flex justify-center bg-transparent pointer-events-none z-[90]">
        <div class="bg-white/90 backdrop-blur-xl border border-gray-200 shadow-2xl rounded-3xl p-1.5 flex gap-1 pointer-events-auto">
            <button onclick="switchView('timer')" id="nav-timer" class="nav-active flex items-center gap-2 px-8 py-3 rounded-2xl text-sm font-bold transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                ã‚¿ã‚¤ãƒãƒ¼
            </button>
            <button onclick="switchView('analytics')" id="nav-analytics" class="flex items-center gap-2 px-8 py-3 rounded-2xl text-sm font-bold transition-all text-gray-500 hover:bg-gray-100">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                è¨˜éŒ²
            </button>
        </div>
    </nav>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒˆãƒ¼ã‚¹ãƒˆ -->
    <div id="subject-modal" class="fixed inset-0 modal-backdrop z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center scale-95 transition-transform">
            <h3 class="text-2xl font-extrabold text-gray-800 mb-6">ä½•ã‚’å‹‰å¼·ã—ã¾ã™ã‹ï¼Ÿ</h3>
            <div id="modal-subject-list" class="grid gap-3 mb-8 max-h-[40vh] overflow-y-auto pr-2 no-scrollbar"></div>
            <button onclick="closeModal('subject-modal')" class="text-gray-400 font-bold text-sm hover:text-gray-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <div id="manage-modal" class="fixed inset-0 modal-backdrop z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center scale-95 transition-transform">
            <h3 class="text-2xl font-extrabold text-gray-800 mb-6">æ•™ç§‘ã®ç®¡ç†</h3>
            <div id="subject-list-container" class="flex flex-wrap gap-2 mb-6 justify-center max-h-[30vh] overflow-y-auto no-scrollbar"></div>
            <div class="flex gap-2 mb-8">
                <input type="text" id="new-subject-input" placeholder="æ•™ç§‘å" class="flex-1 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-red-200">
                <button onclick="addSubject()" class="px-6 py-3 bg-gray-800 text-white rounded-xl text-sm font-bold hover:bg-gray-700 transition-colors">è¿½åŠ </button>
            </div>
            <button onclick="closeModal('manage-modal')" class="w-full py-3 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200 transition-all">å®Œäº†</button>
        </div>
    </div>

    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full text-sm font-medium shadow-lg transform -translate-y-20 opacity-0 transition-all duration-300 z-[110]">
        æ™‚é–“ã«ãªã‚Šã¾ã—ãŸï¼
    </div>

    <script>
        // --- 1. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
        function formatDate(date) {
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        function formatFullTime(sec) {
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            return `${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`;
        }

        // --- 2. çŠ¶æ…‹ç®¡ç† ---
        let timeLeft = 25 * 60, timerId = null, currentMode = 'work', totalTime = 25 * 60;
        let viewDate = new Date(), selectedDate = new Date(), currentSubject = null, currentView = 'timer';
        let history = JSON.parse(localStorage.getItem('study_history_v3') || '{}');
        let subjects = JSON.parse(localStorage.getItem('study_subjects') || '["æ•°å­¦", "è‹±èª", "å›½èª", "ç†ç§‘", "ç¤¾ä¼š"]');
        const subjectColors = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899", "#06b6d4"];

        const modes = {
            work: { time: 25 * 60, color: 'text-red-500', bg: 'mode-work', btn: 'bg-red-500', btnHover: 'hover:bg-red-600', tabColor: 'text-red-600', label: 'Study Time' },
            short: { time: 5 * 60, color: 'text-green-500', bg: 'mode-short-break', btn: 'bg-green-500', btnHover: 'hover:bg-green-600', tabColor: 'text-green-600', label: 'Take a Break' },
            long: { time: 15 * 60, color: 'text-blue-500', bg: 'mode-long-break', btn: 'bg-blue-500', btnHover: 'hover:bg-blue-600', tabColor: 'text-blue-600', label: 'Long Rest' }
        };

        // --- 3. è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ ---
        function switchView(view) {
            currentView = view;
            const timerV = document.getElementById('timer-view');
            const analyticsV = document.getElementById('analytics-view');
            const navT = document.getElementById('nav-timer');
            const navA = document.getElementById('nav-analytics');

            if (view === 'timer') {
                timerV.classList.add('active');
                analyticsV.classList.remove('active');
                navT.classList.add('nav-active');
                navT.classList.remove('text-gray-500');
                navA.classList.remove('nav-active');
                navA.classList.add('text-gray-500');
            } else {
                analyticsV.classList.add('active');
                timerV.classList.remove('active');
                navA.classList.add('nav-active');
                navA.classList.remove('text-gray-500');
                navT.classList.remove('nav-active');
                navT.classList.add('text-gray-500');
                renderCalendar();
                renderWeeklyChart();
            }
        }

        function setMode(mode) {
            currentMode = mode;
            totalTime = modes[mode].time;
            timeLeft = totalTime;
            currentSubject = null;
            document.body.className = `min-h-screen flex flex-col items-center justify-center ${modes[mode].bg}`;
            document.getElementById('progress-ring').setAttribute('class', `progress-ring__circle ${modes[mode].color}`);
            document.getElementById('start-btn').className = `flex-[2] py-4 ${modes[mode].btn} ${modes[mode].btnHover} text-white rounded-2xl font-bold text-lg transition-all btn-shadow uppercase`;
            document.getElementById('current-subject-display').textContent = modes[mode].label;
            
            // ãƒŠãƒ“ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è‰²ã‚‚æ›´æ–°
            const activeNav = document.querySelector('.nav-active');
            if (activeNav) activeNav.style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--theme-color');

            ['work', 'short', 'long'].forEach(m => {
                const tab = document.getElementById(`tab-${m}`);
                tab.className = m === mode ? `flex-1 py-2 px-2 rounded-xl text-xs md:text-sm font-semibold transition-all bg-white shadow-sm ${modes[mode].tabColor}` : `flex-1 py-2 px-2 rounded-xl text-xs md:text-sm font-semibold transition-all text-gray-500 hover:text-gray-700`;
            });

            pauseTimer();
            updateDisplay();
        }

        // --- 4. ã‚¿ã‚¤ãƒãƒ¼åˆ¶å¾¡ ---
        function handleStartClick() {
            if (timerId) pauseTimer();
            else if (currentMode === 'work') openSubjectSelection();
            else startTimer();
        }

        function openSubjectSelection() {
            const list = document.getElementById('modal-subject-list');
            list.innerHTML = '';
            subjects.forEach((s, i) => {
                const btn = document.createElement('button');
                btn.className = 'w-full py-4 px-6 rounded-2xl font-bold text-white transition-transform active:scale-95 shadow-lg';
                btn.style.backgroundColor = subjectColors[i % subjectColors.length];
                btn.textContent = s;
                btn.onclick = () => { currentSubject = s; closeModal('subject-modal'); startTimer(); };
                list.appendChild(btn);
            });
            document.getElementById('subject-modal').classList.remove('hidden');
        }

        function startTimer() {
            if (timerId) return;
            document.getElementById('start-btn').textContent = 'PAUSE';
            document.getElementById('current-subject-display').textContent = currentSubject || modes[currentMode].label;
            timerId = setInterval(() => {
                timeLeft--;
                if (currentMode === 'work' && currentSubject) {
                    const key = formatDate(new Date());
                    if (!history[key]) history[key] = {};
                    history[key][currentSubject] = (history[key][currentSubject] || 0) + 1;
                    if (timeLeft % 10 === 0) saveData();
                    updateStatsUI();
                }
                updateDisplay();
                if (timeLeft <= 0) handleTimerComplete();
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timerId);
            timerId = null;
            document.getElementById('start-btn').textContent = 'START';
            saveData();
            updateStatsUI();
        }

        function handleTimerComplete() { pauseTimer(); showToast(); }
        function saveData() { localStorage.setItem('study_history_v3', JSON.stringify(history)); }
        function resetTimer() {
            pauseTimer();
            timeLeft = totalTime;
            currentSubject = null;
            document.getElementById('current-subject-display').textContent = modes[currentMode].label;
            updateDisplay();
        }

        // --- 5. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»åˆ†æ ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            document.getElementById('calendar-month').textContent = `${year}å¹´ ${month + 1}æœˆ`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            grid.innerHTML = 'æ—¥,æœˆ,ç«,æ°´,æœ¨,é‡‘,åœŸ'.split(',').map(d => `<div class="text-[10px] font-bold text-gray-400 uppercase">${d}</div>`).join('');
            for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));
            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(year, month, day), key = formatDate(dateObj);
                const total = Object.values(history[key] || {}).reduce((a, b) => a + b, 0);
                const dayEl = document.createElement('button');
                dayEl.onclick = () => { selectedDate = new Date(year, month, day); renderCalendar(); renderWeeklyChart(); };
                let intensity = 0;
                if (total > 0) intensity = 1;
                if (total > 3600) intensity = 2;
                if (total > 7200) intensity = 3;
                if (total > 14400) intensity = 4;
                const isSelected = key === formatDate(selectedDate);
                dayEl.className = `calendar-day w-full flex items-center justify-center text-[10px] font-bold rounded-lg transition-all border intensity-${intensity} ${intensity > 2 ? 'text-white' : 'text-gray-600'} ${isSelected ? 'ring-2 ring-blue-400 border-white z-10' : 'border-transparent'}`;
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            }
        }

        function renderWeeklyChart() {
            const chart = document.getElementById('weekly-chart');
            if (!chart) return;
            const date = new Date(selectedDate);
            const day = date.getDay();
            const monday = new Date(date.setDate(date.getDate() - day + (day === 0 ? -6 : 1)));
            chart.innerHTML = '';
            document.getElementById('week-label').textContent = `${monday.getMonth()+1}/${monday.getDate()} ã€œ`;
            let maxDaily = 3600; 
            const weekKeys = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday); d.setDate(monday.getDate() + i);
                const key = formatDate(d); weekKeys.push(key);
                const total = Object.values(history[key] || {}).reduce((a, b) => a + b, 0);
                if (total > maxDaily) maxDaily = total;
            }
            weekKeys.forEach((key, idx) => {
                const dayData = history[key] || {}, total = Object.values(dayData).reduce((a, b) => a + b, 0);
                const container = document.createElement('div');
                container.className = 'flex-1 flex flex-col items-center group relative';
                const wrapper = document.createElement('div');
                wrapper.className = 'w-full bg-gray-100 rounded-t-sm overflow-hidden flex flex-col-reverse';
                wrapper.style.height = `${(total / maxDaily) * 100}%`;
                Object.entries(dayData).forEach(([sub, sec]) => {
                    const segment = document.createElement('div');
                    segment.style.backgroundColor = subjectColors[subjects.indexOf(sub) % subjectColors.length] || '#ccc';
                    segment.style.height = `${(sec / total) * 100}%`;
                    wrapper.appendChild(segment);
                });
                const label = document.createElement('span');
                label.className = 'text-[8px] font-bold text-gray-400 mt-2 uppercase';
                label.textContent = 'æœˆç«æ°´æœ¨é‡‘åœŸæ—¥'[idx];
                container.append(wrapper, label);
                chart.appendChild(container);
            });
        }

        function updateStatsUI() {
            const key = formatDate(new Date());
            const sec = Object.values(history[key] || {}).reduce((a, b) => a + b, 0);
            document.getElementById('total-study-time').textContent = formatFullTime(sec);
            if (currentView === 'analytics') renderWeeklyChart();
        }

        function updateDisplay() {
            const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            document.getElementById('timer-display').textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            const circumference = 2 * Math.PI * 150;
            document.getElementById('progress-ring').style.strokeDashoffset = circumference - (timeLeft / totalTime) * circumference;
            document.title = `${document.getElementById('timer-display').textContent} - Timer`;
        }

        function changeMonth(offset) { viewDate.setMonth(viewDate.getMonth() + offset); renderCalendar(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openManageModal() { renderManageSubjects(); document.getElementById('manage-modal').classList.remove('hidden'); }
        
        function renderManageSubjects() {
            const cont = document.getElementById('subject-list-container');
            cont.innerHTML = '';
            subjects.forEach((s, i) => {
                const tag = document.createElement('div');
                tag.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold text-white shadow-sm';
                tag.style.backgroundColor = subjectColors[i % subjectColors.length];
                tag.innerHTML = `<span>${s}</span><button onclick="removeSubject('${s}')" class="p-1 hover:text-black">âœ•</button>`;
                cont.appendChild(tag);
            });
        }

        function addSubject() {
            const input = document.getElementById('new-subject-input');
            const val = input.value.trim();
            if (val && !subjects.includes(val)) {
                subjects.push(val); localStorage.setItem('study_subjects', JSON.stringify(subjects));
                input.value = ''; renderManageSubjects();
            }
        }

        function removeSubject(sub) {
            subjects = subjects.filter(s => s !== sub);
            localStorage.setItem('study_subjects', JSON.stringify(subjects));
            renderManageSubjects();
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.classList.remove('-translate-y-20', 'opacity-0');
            t.classList.add('translate-y-0');
            setTimeout(() => { t.classList.remove('translate-y-0'); t.classList.add('-translate-y-20', 'opacity-0'); }, 4000);
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.setValueAtTime(880, ctx.currentTime);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            osc.start(); osc.stop(ctx.currentTime + 0.5);
        }

        // --- åˆæœŸèµ·å‹• ---
        renderCalendar();
        updateStatsUI();
        updateDisplay();
        
        // PWAç”¨ã®Service Worker
        if ('serviceWorker' in navigator) {
            const blob = new Blob(["self.addEventListener('fetch', function(e){})"], {type: 'application/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});
        }
    </script>
</body>
</html>
